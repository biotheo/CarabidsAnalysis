---
title: "ANALISI CARABIDI - LAST UPDATE"
output:
  html_document:
    df_print: paged
---
# Upload of dataset and packages
```{r message=FALSE, warning=FALSE}
CSS <- read.csv("Cossogno_DB.csv")
CSS <- CSS[, -6:-13] # empty coloumns
CLL <- read.csv("Colloro_DB.csv")

library(dplyr)
library(ggplot2)
library(vegan)
```

## Data

Here's the dataset used to perform the subsequent analysis:

- [Link_1](https://www.google.it)
- [Link_2](https://www.google.it)
- [Link_3](https://www.google.it)

## Activity Density

Activity Density (hereafter AD) 

Formula: $$\text{AD} = \frac{\text{number of individuals}}{\text{number of traps}} * \frac{\text{number of sampling}}{\text{total days of fieldwork}}$$

```{r message=FALSE, warning=FALSE}
# Number of species by year by site
## Cossogno
sppCSS_21 <- 24
sppCSS_22 <- 22
## Colloro
sppCLL_21 <- 12
sppCLL_22 <- 11

# Days of total fieldwork by year
ggtot_2021 <- 135
ggtot_2022 <- 120

# Sampling period each trap
gg_trap <- 15

# Numb of traps by site per habitat
trapNumb_CSS <- 15
trapNumb_CLL <- 4
```

Somma individui per habitat per anno / num trappole per sito
```{r message=FALSE}
CLL_HabYear <- CLL%>%
  group_by(habitat, anno) %>%
  summarise(sum(n_sp)/trapNumb_CLL)

CSS_HabYear <- CSS%>%
  group_by(habitat, anno) %>%
  summarise(sum(n_sp)/trapNumb_CSS)

print(CLL_HabYear)
print(CSS_HabYear)
```

```{r message=FALSE, warning=FALSE}
AD_LL <- c(
  AD_LL_Bosco21 <- 6.5 * (gg_trap/ggtot_2021),
  AD_LL_Felci21 <- 17 * (gg_trap/ggtot_2021),
  AD_LL_Prato21 <- 3.75 * (gg_trap/ggtot_2021),
  AD_LL_Bosco22 <- 5.75 * (gg_trap/ggtot_2022),
  AD_LL_Felci22 <- 3 * (gg_trap/ggtot_2022),
  AD_LL_Prato22 <- 4.75 * (gg_trap/ggtot_2022)
          )

AD_SS <- c(
  AD_SS_Castagneto21 <- 20.27 * (gg_trap/ggtot_2021),
  AD_SS_Ecotono21 <- 51.6 * (gg_trap/ggtot_2021),
  AD_SS_Prato21 <- 35.07 * (gg_trap/ggtot_2021),
  AD_SS_Castagento22 <- 22.8 * (gg_trap/ggtot_2022),
  AD_SS_Ecotono22 <- 18.53 * (gg_trap/ggtot_2022),
  AD_SS_Prato22 <- 21.33 * (gg_trap/ggtot_2022)
          )
```

```{r message=FALSE, warning=FALSE}
# Colloro
sum_n_spLL <- CLL %>%
  group_by(anno, habitat) %>%
  summarise(total_n_spLL = sum(n_sp, na.rm = TRUE))

mean_se_n_spLL <- CLL %>%
  group_by(anno, habitat, specie) %>%
  summarise(mean_n_sp_per_specieLL = mean(n_sp, na.rm = TRUE)) %>%
  group_by(anno, habitat) %>%
  summarise(mean_n_spLL = mean(mean_n_sp_per_specieLL, na.rm = TRUE),
            se_n_spLL = sd(mean_n_sp_per_specieLL, na.rm = TRUE) / sqrt(n()))

combined_resultsLL <- sum_n_spLL %>%
  left_join(mean_se_n_spLL, by = c("anno", "habitat"))

print(combined_resultsLL)

## Cossogno
sum_n_spSS <- CSS %>%
  group_by(anno, habitat) %>%
  summarise(total_n_spSS = sum(n_sp, na.rm = TRUE))

mean_se_n_spSS <- CSS %>%
  group_by(anno, habitat, specie) %>%
  summarise(mean_n_sp_per_specieSS = mean(n_sp, na.rm = TRUE)) %>%
  group_by(anno, habitat) %>%
  summarise(mean_n_spSS = mean(mean_n_sp_per_specieSS, na.rm = TRUE),
            se_n_spSS = sd(mean_n_sp_per_specieSS, na.rm = TRUE) / sqrt(n()))

combined_resultsSS <- sum_n_spSS %>%
  left_join(mean_se_n_spSS, by = c("anno", "habitat"))

print(combined_resultsSS)
```

```{r message=FALSE, warning=FALSE}
ADdf_LL <- data.frame(
  Habitat = c("Forest", "Ferns", "Grassland", "Forest", "Ferns", "Grassland"),
  Year = rep(c("2021", "2022"), each = 3),
  DA = AD_LL,
  SE = combined_resultsLL$se_n_spLL
)

ADdf_SS <- data.frame(
  Habitat = c("Chestnut grove", "Ecotone", "Grassland", "Chestnut grove", "Ecotone", "Grassland"),
  Year = rep(c("2021", "2022"), each = 3),
  DA = AD_SS,
  SE = combined_resultsSS$se_n_spSS
)
```

```{r message=FALSE, warning=FALSE}
# Colloro
barplot_AD_LL<- ggplot(ADdf_LL, aes(x = Habitat, y = DA, color = as.factor(Year))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), fill = NA, width = 0.5) +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) +
  geom_errorbar(aes(ymin = DA - SE, ymax = DA + SE), position = position_dodge(width = 0.75), width = 0.1) +
  labs(title = "(A)", 
       x = "", 
       y = "AD",
       color = "Year") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20, color = "black"),
    panel.grid = element_blank(),  # togliamo le griglie
    panel.background = element_rect(fill = "white")  # sfondo bianco
  )

# Cossogno
barplot_AD_SS <- ggplot(ADdf_SS, aes(x = Habitat, y = DA, color = as.factor(Year))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), fill = NA, width = 0.5) +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) +
  geom_errorbar(aes(ymin = DA - SE, ymax = DA + SE), position = position_dodge(width = 0.75), width = 0.1) +
  labs(title = "(B)", 
       x = "", 
       y = "AD",
       color = "Year") +
  theme_classic() +
  theme(
    text = element_text(family = "Arial", size = 20, color = "black"),
    panel.grid = element_blank(),  # togliamo le griglie
    panel.background = element_rect(fill = "white")  # sfondo bianco
  )

barplot_AD_LL
barplot_AD_SS
```

## Average number of species per trap

```{r message=FALSE, warning=FALSE}
dd<-read.csv("ResumeCarabids2.csv")

## COLLORO
ddColl<-dd[dd$sito=="colloro",]

boxColl <- ggplot(ddColl, aes(x = habitat, y = n_specie, color = as.factor(anno))) +
  geom_boxplot(position = position_dodge(width = 0.75)) +
  labs(title = "(A)",
       x = "",
       y = "Average n of species",
       color = "Year") +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) + # colori per i diversi anni
  theme_classic() +
  theme(text=element_text(family="Arial", size = 20),
        panel.grid = element_blank(), # togliamo le griglie
        panel.background = element_rect(fill = "white")) # sfondo bianco)

boxColl

## COSSOGNO
ddCoss<-dd[dd$sito=="cicogna",]

boxCoss <- ggplot(ddCoss, aes(x = habitat, y = n_specie, color = as.factor(anno))) +
  geom_boxplot(position = position_dodge(width = 0.85), fill = NA) +
  labs(title = "(B)",
       x = "",
       y = "Average n of species",
       color = "Year") +
  scale_x_discrete(labels = c("Chestnut_grove" = "Chestnut grove", "Ecotone" = "Ecotone", "Grassland" = "Grassland")) + 
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) + # colori per i diversi anni
  theme_classic()+
  theme(text=element_text(family="Arial", size = 20),
        panel.grid = element_blank(), # togliamo le griglie
        panel.background = element_rect(fill = "white")) # sfondo bianco)

boxCoss
```

## Biodiversity Indexes

- Create new database with total number of individual per species, divided by habitat type.
- Substitute variable *habitat* (type: string) with a numeric value (type: int). The values were 

| **Colloro** |   | **Cossogno**  |   |
|-------------|---|---------------|---|
| Grassland   | 1 |Chestnut grove | 1 |
| Ferns       | 2 |Grassland      | 2 |
| Forest      | 3 |Ecotone        | 3 |
  
- Load dataset

```{r message=FALSE, warning=FALSE}
biodivDB_CLL21 <- read.csv("BiodivDB_Colloro21.csv")
biodivDB_CLL22 <- read.csv("BiodivDB_Colloro22.csv")
biodivDB_CSS21 <- read.csv("BiodivDB_Cossogno21.csv")
biodivDB_CSS22 <- read.csv("BiodivDB_Cossogno22.csv")
```

**Shannon-Wiener's index** using *Vegan* package 

```{r message=FALSE, warning=FALSE}

SH_CLL21 <- diversity(biodivDB_CLL21, index = "shannon")
SH_CLL22 <- diversity(biodivDB_CLL22, index = "shannon")
SH_CSS21 <- diversity(biodivDB_CSS21, index = "shannon")
SH_CSS22 <- diversity(biodivDB_CSS22, index = "shannon")

# Colloro
habitatCLL <- c("Grassland", "Ferns", "Forest")

dfSH_CLL <- data.frame(Habitat = rep(habitatCLL, 2), 
                  Year = c(rep("2021", 3), rep("2022", 3)), 
                  Shannon = c(SH_CLL21, SH_CLL22))

SH_CLL_plot <- ggplot(dfSH_CLL, aes(x = Habitat, y = Shannon, color = as.factor(Year))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.65), fill = NA, width = 0.5) +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) +
  labs(title = "(A)", x = "", y = "Shannon-Wiener index (H')", color = "Year") +
  theme_classic() +  # Cambiamo il tema a classic per avere uno sfondo bianco
  theme(
    text = element_text(family = "Arial", size = 25),
    panel.grid = element_blank(),  # Togliamo le griglie
    panel.background = element_rect(fill = "white")  # Sfondo bianco
  )

# Cossogno
habitatCSS <- c("Chestnut grove   ", "Grassland", "Ecotone")

dfSH_CSS <- data.frame(Habitat = rep(habitatCSS, 2), 
                  Year = c(rep("2021", 3), rep("2022", 3)), 
                  Shannon = c(SH_CSS21, SH_CSS22))

SH_CSS_plot <- ggplot(dfSH_CSS, aes(x = Habitat, y = Shannon, color = as.factor(Year))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.65), fill = NA, width = 0.5) +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) +
  labs(title = "(A)", x = "", y = "Shannon-Wiener index (H')", color = "Year") +
  theme_classic() +  # Cambiamo il tema a classic per avere uno sfondo bianco
  theme(
    text = element_text(family = "Arial", size = 25),
    panel.grid = element_blank(),  # Togliamo le griglie
    panel.background = element_rect(fill = "white")  # Sfondo bianco
  )

SH_CLL_plot
SH_CSS_plot
```

**Simpson's index** using *Vegan* package 

```{r message=FALSE, warning=FALSE}

SP_CLL21 <- diversity(biodivDB_CLL21, index = "simpson")
SP_CLL22 <- diversity(biodivDB_CLL22, index = "simpson")
SP_CSS21 <- diversity(biodivDB_CSS21, index = "simpson")
SP_CSS22 <- diversity(biodivDB_CSS22, index = "simpson")

# Colloro
habitatCLL <- c("Grassland", "Ferns", "Forest")

dfSP_CLL <- data.frame(Habitat = rep(habitatCLL, 2), 
                  Year = c(rep("2021", 3), rep("2022", 3)), 
                  Simpson = c(SP_CLL21, SP_CLL22))

SP_CLL_plot <- ggplot(dfSP_CLL, aes(x = Habitat, y = Simpson, color = as.factor(Year))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.65), fill = NA, width = 0.5) +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) +
  labs(title = "(B)", x = "", y = "Simpson index (D)", color = "Year") +
  theme_classic() +  # Cambiamo il tema a classic per avere uno sfondo bianco
  theme(
    text = element_text(family = "Arial", size = 25),
    panel.grid = element_blank(),  # Togliamo le griglie
    panel.background = element_rect(fill = "white")  # Sfondo bianco
  )

# Cossogno
habitatCSS <- c("Chestnut grove   ", "Grassland", "Ecotone")

dfSP_CSS <- data.frame(Habitat = rep(habitatCSS, 2), 
                  Year = c(rep("2021", 3), rep("2022", 3)), 
                  Simpson = c(SP_CSS21, SP_CSS22))

SP_CSS_plot <- ggplot(dfSP_CSS, aes(x = Habitat, y = Simpson, color = as.factor(Year))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.65), fill = NA, width = 0.5) +
  scale_color_manual(values = c("2021" = "#33cc33", "2022" = "#0033cc")) +
  labs(title = "(B)", x = "", y = "Simpson index (D)", color = "Year") +
  theme_classic() +  # Cambiamo il tema a classic per avere uno sfondo bianco
  theme(
    text = element_text(family = "Arial", size = 25),
    panel.grid = element_blank(),  # Togliamo le griglie
    panel.background = element_rect(fill = "white")  # Sfondo bianco
  )

SP_CLL_plot
SP_CSS_plot
```

### Resuming the values of the previous calculation:

![Colloro_BiodivIndex](/home/matteo/GitHub_BioTheo/AnalisiSerenaCarabidi/Colloro_Index.png)

![Cossogno_BiodivIndex](/home/matteo/GitHub_BioTheo/AnalisiSerenaCarabidi/Cossogno_Index.png)

## NMDS 

Non-metric multidimensional scaling (euclidean distances)

```{r message=FALSE, warning=FALSE}
NMDS_Colloro_x_R<-read.csv("CLL_NMDS.csv")

#Dividere il file in due dataset, 1 con il numero delle specie e uno con habitat e numero della trappola
data_1_CLL<-NMDS_Colloro_x_R[,3:18]
data_2_CLL<-NMDS_Colloro_x_R[,1:2]


NMDS_CLL<-metaMDS(data_1_CLL, distance="euclidean", k=2)

#Grafico solo con punti colorati
ggplot(data_2_CLL, aes(x = NMDS_CLL$points[,1], y = NMDS_CLL$points[,2], color = habitat, shape = habitat)) +
  geom_point(size = 2) +
  labs(title = "(A)", x = "Axis 1", y = "Axis 2", color = "Habitat", shape = "Habitat") +
  theme_classic() +
  theme(text = element_text(family = "Arial", size = 25))

# Grafico con poligoni colorati intorno ai punti
ggplot(data_2_CLL, aes(x = NMDS_CLL$points[,1], y = NMDS_CLL$points[,2], fill = habitat, color = habitat)) +
  geom_point(size = 2) +
  geom_polygon(data = data_2_CLL, aes(x = NMDS_CLL$points[,1], y = NMDS_CLL$points[,2], fill = habitat, color = habitat), alpha = 0.3) +
  labs(title = "(B)", x = " ", y = " ", color = "Habitat", shape = "Habitat") +
  theme_classic() + 
  theme(
    text = element_text(family = "Arial", size = 25),
    panel.grid = element_blank(),  # Togliamo le griglie
    panel.background = element_rect(fill = "white")  # Sfondo bianco
  )
```

```{r message=FALSE, warning=FALSE}
NMDS_Cossogno_x_R<-read.csv("CSS_NMDS.csv")

#Dividere il file in due dataset, 1 con il numero delle specie e uno con habitat e numero della trappola
data_1_CSS<-NMDS_Cossogno_x_R[,3:31]
data_2_CSS<-NMDS_Cossogno_x_R[,1:2]


NMDS_CSS<-metaMDS(data_1_CSS, distance="euclidean", k=2)

#Grafico solo con punti colorati
ggplot(data_2_CSS, aes(x = NMDS_CSS$points[,1], y = NMDS_CSS$points[,2], color = habitat, shape = habitat)) +
  geom_point(size = 2) +
  labs(title = "(A)", x = "Axis 1", y = "Axis 2", color = "Habitat", shape = "Habitat") +
  theme_classic() +
  theme(text = element_text(family = "Arial", size = 20))

# Grafico con poligoni colorati intorno ai punti
ggplot(data_2_CSS, aes(x = NMDS_CSS$points[,1], y = NMDS_CSS$points[,2], color = habitat, shape = habitat)) +
 geom_point(size = 2) +
 geom_polygon(data = data_2_CSS, aes(x = NMDS_CSS$points[,1], y = NMDS_CSS$points[,2], group = habitat, fill = habitat), alpha = 0.2) +
 labs(title = "(B)", x = " ", y = " ", color = "Habitat", shape = "Habitat") +
 theme_minimal() +
 theme(text = element_text(family = "Arial", size = 20))
```

- e n d -